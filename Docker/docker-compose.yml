services:
  backend:
    build:
      context: .. # Points to the parent directory (CipherNet/)
      dockerfile: docker/backend.Dockerfile # Specify Dockerfile for backend
    ports:
      - "3001:3000" # Map host port 3001 to container port 3000
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_URI=mongodb://database:27017/ciphernet
    volumes:
      - ../backend:/usr/src/app/backend # Mount backend source code
      - /usr/src/app/backend/node_modules # Persist node_modules
    depends_on:
      database:
        condition: service_healthy # Ensure the database starts first
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  frontend:
    build:
      context: .. # Points to the parent directory (CipherNet/)
      dockerfile: docker/frontend.Dockerfile # Specify Dockerfile for frontend
    ports:
      - "8080:8080" # Map host port 8080 to container port 8080
    volumes:
      - ../frontend:/usr/src/app/frontend # Mount frontend source code
      - /usr/src/app/frontend/node_modules # Persist node_modules
    depends_on:
      backend:
        condition: service_healthy # Ensure the backend starts before frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  database:
    image: mongo:5.0 # Use a stable MongoDB version
    ports:
      - "27018:27017" # Map host port 27018 to MongoDB container port 27017
    volumes:
      - db_data:/data/db # Persist database data
    environment:
      - MONGO_INITDB_DATABASE=ciphernet
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  db_data: # Named volume for MongoDB data
